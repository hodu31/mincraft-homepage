<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minecraft Server Manager</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Phosphor Icons (Clean icons) -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .tier-badge-Admin {
            background: linear-gradient(135deg, #FFD700 0%, #FDB931 100%);
            color: #856404;
            border: 1px solid #e3c02d;
            box-shadow: 0 0 5px rgba(255, 215, 0, 0.4);
        }

        .tier-badge-Free {
            background: linear-gradient(135deg, #E0E0E0 0%, #BDBDBD 100%);
            color: #424242;
            border: 1px solid #9e9e9e;
        }

        /* Modal Overlay */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        /* Table Styles */
        .custom-table th {
            text-align: left;
            padding: 12px 16px;
            background-color: #f9fafb;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #6b7280;
            border-bottom: 1px solid #e5e7eb;
        }

        .custom-table td {
            padding: 12px 16px;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.875rem;
            color: #111827;
        }

        .custom-table tr:last-child td {
            border-bottom: none;
        }
    </style>
</head>

<body class="text-gray-800 h-screen flex flex-col overflow-hidden">

    <!-- Top Navigation -->
    <nav class="bg-white shadow-sm border-b border-gray-200 z-10 flex-shrink-0">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center gap-2 cursor-pointer" onclick="app.navigateTo('dashboard')">
                    <i class="ph-fill ph-cube text-3xl text-indigo-600"></i>
                    <span class="font-bold text-xl tracking-tight text-gray-900">MC Server Manager</span>
                </div>
                <div class="flex items-center gap-4">
                    <div id="userProfile"
                        class="hidden flex items-center gap-2 bg-gray-50 px-3 py-1.5 rounded-full border border-gray-200">
                        <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 font-bold"
                            id="userAvatar">
                            U
                        </div>
                        <span class="text-sm font-medium text-gray-700" id="userName">User</span>
                        <button onclick="logout()" class="ml-2 text-gray-400 hover:text-red-500 transition-colors"
                            title="로그아웃">
                            <i class="ph ph-sign-out text-lg"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main id="appRoot" class="flex-1 overflow-y-auto relative p-4 sm:p-6 lg:p-8">
        <!-- Dynamic Content will be injected here -->
    </main>

    <!-- Create Server Modal -->
    <div id="createModal" class="fixed inset-0 z-50 hidden flex items-center justify-center">
        <div class="modal-overlay absolute inset-0" onclick="app.closeModal()"></div>
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden fade-in relative z-10 m-4">
            <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                <h3 class="text-lg font-semibold text-gray-900">새 서버 만들기</h3>
                <button onclick="app.closeModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="ph ph-x text-xl"></i>
                </button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">서버 이름 (Pod Name)</label>
                    <input type="text" id="inputPodName" oninput="app.handlePodNameInput(this.value)"
                        placeholder="my-server"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all">
                    <p class="text-xs text-gray-500 mt-1">영문 소문자, 숫자, 하이픈(-)만 사용 가능</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">데이터 저장소 (PVC)</label>
                    <input type="text" id="inputPvcName" disabled
                        class="w-full px-4 py-2 bg-gray-100 border border-gray-200 rounded-lg text-gray-500 cursor-not-allowed"
                        placeholder="자동 생성됩니다">
                </div>

                <!-- Mods Selection (Dummy Data) -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">모드 선택 (선택사항)</label>
                    <div class="space-y-2 max-h-32 overflow-y-auto border border-gray-200 rounded-lg p-3 bg-gray-50">
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" class="form-checkbox text-indigo-600 rounded">
                            <span class="text-sm text-gray-700">EssentialsX (기본 유틸리티)</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" class="form-checkbox text-indigo-600 rounded">
                            <span class="text-sm text-gray-700">WorldEdit (월드 편집)</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" class="form-checkbox text-indigo-600 rounded">
                            <span class="text-sm text-gray-700">LuckPerms (권한 관리)</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" class="form-checkbox text-indigo-600 rounded">
                            <span class="text-sm text-gray-700">Vault (경제 API)</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" class="form-checkbox text-indigo-600 rounded">
                            <span class="text-sm text-gray-700">Multiverse-Core (멀티월드)</span>
                        </label>
                    </div>
                </div>

                <div class="pt-2">
                    <button onclick="app.submitCreateServer()" id="btnCreateServer"
                        class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2.5 rounded-lg shadow-md transition-all flex justify-center items-center gap-2">
                        <span>서버 생성하기</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Action Button (FAB) -->
    <button onclick="app.openModal()" id="fab"
        class="fixed bottom-8 right-8 bg-indigo-600 hover:bg-indigo-700 text-white p-4 rounded-full shadow-lg transition-transform hover:scale-110 active:scale-95 z-40 hidden">
        <i class="ph-bold ph-plus text-2xl"></i>
    </button>

    <!-- Templates -->

    <!-- Login View Template -->
    <template id="tmpl-login">
        <div class="max-w-md mx-auto mt-10 fade-in">
            <div class="bg-white rounded-2xl shadow-xl p-8 text-center">
                <div class="mb-6 inline-flex p-4 rounded-full bg-indigo-50 text-indigo-600">
                    <i class="ph-duotone ph-game-controller text-4xl"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-900 mb-2">Minecraft Server Manager</h1>
                <p class="text-gray-500 mb-8">서버를 쉽고 간편하게 관리하세요</p>

                <div class="space-y-4">
                    <button onclick="login()"
                        class="w-full bg-[#FF9900] hover:bg-[#e68a00] text-white font-bold py-3 px-4 rounded-lg transition-colors flex items-center justify-center gap-3 shadow-md">
                        <i class="ph-bold ph-sign-in"></i>
                        Cognito 로그인
                    </button>

                    <div class="relative my-6">
                        <div class="absolute inset-0 flex items-center">
                            <div class="w-full border-t border-gray-200"></div>
                        </div>
                        <div class="relative flex justify-center text-sm">
                            <span class="px-2 bg-white text-gray-500">Developers</span>
                        </div>
                    </div>

                    <div class="text-left bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <label class="block text-xs font-semibold text-gray-500 uppercase mb-2">Local Test Token</label>
                        <textarea id="idTokenInput" placeholder="Paste ID Token here..."
                            class="w-full h-20 px-3 py-2 text-xs font-mono bg-white border border-gray-300 rounded focus:ring-1 focus:ring-indigo-500 outline-none resize-none"></textarea>
                        <button onclick="localLogin()"
                            class="mt-2 w-full bg-gray-800 hover:bg-gray-900 text-white text-sm font-medium py-2 rounded transition-colors">
                            로컬 로그인
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <!-- Dashboard (Server List) Template -->
    <template id="tmpl-dashboard">
        <div class="max-w-7xl mx-auto fade-in">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900">내 서버 목록</h2>
            </div>

            <div id="serverGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Server Cards injected here -->
            </div>
        </div>
    </template>

    <!-- Control Panel Template -->
    <template id="tmpl-control-panel">
        <div class="max-w-7xl mx-auto fade-in h-full flex flex-col">
            <button onclick="app.navigateTo('dashboard')"
                class="mb-4 inline-flex items-center text-gray-500 hover:text-indigo-600 transition-colors self-start">
                <i class="ph-bold ph-arrow-left mr-1"></i> 목록으로 돌아가기
            </button>

            <div class="flex flex-col lg:flex-row gap-6 h-full">
                <!-- Sidebar -->
                <div class="w-full lg:w-64 flex-shrink-0 space-y-2">
                    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200 mb-4">
                        <div class="flex items-center gap-3 mb-2">
                            <div class="w-3 h-3 rounded-full" id="detailStatusDot"></div>
                            <h2 class="text-xl font-bold truncate" id="detailServerName">Server Name</h2>
                        </div>
                        <div class="text-xs text-gray-500 font-mono bg-gray-100 p-2 rounded break-all select-all cursor-pointer hover:bg-gray-200 transition-colors"
                            onclick="app.copyToClipboard(this.innerText)" title="클릭하여 복사" id="detailServerIp">
                            IP Address
                        </div>

                        <!-- Power Controls -->
                        <div class="mt-4 pt-4 border-t border-gray-100 flex gap-2" id="powerControls">
                            <!-- Buttons injected dynamically -->
                        </div>
                    </div>

                    <nav class="space-y-1">
                        <button onclick="app.switchTab('overview')"
                            class="tab-btn w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 transition-colors font-medium bg-white text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 active-tab"
                            data-tab="overview">
                            <i class="ph-duotone ph-chart-line-up text-xl"></i> 개요 (Overview)
                        </button>
                        <button onclick="app.switchTab('game')"
                            class="tab-btn w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 transition-colors font-medium bg-white text-gray-700 hover:bg-indigo-50 hover:text-indigo-600"
                            data-tab="game">
                            <i class="ph-duotone ph-users-three text-xl"></i> 플레이어 및 관리
                        </button>
                        <button onclick="app.switchTab('settings')"
                            class="tab-btn w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 transition-colors font-medium bg-white text-gray-700 hover:bg-indigo-50 hover:text-indigo-600"
                            data-tab="settings">
                            <i class="ph-duotone ph-gear text-xl"></i> 설정 (Settings)
                        </button>
                    </nav>
                </div>

                <!-- Content -->
                <div class="flex-1 bg-white rounded-xl shadow-sm border border-gray-200 p-6 overflow-y-auto">

                    <!-- Overview Tab -->
                    <div id="tab-overview" class="tab-content space-y-6">
                        <div class="flex justify-between items-center pb-4 border-b border-gray-100">
                            <h3 class="text-lg font-bold text-gray-900">리소스 모니터링</h3>
                            <div class="flex gap-2">
                                <button onclick="app.fetchStatus(true)"
                                    class="p-2 text-gray-500 hover:text-indigo-600 rounded-lg hover:bg-gray-100"
                                    title="새로고침">
                                    <i class="ph-bold ph-arrows-clockwise"></i>
                                </button>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- CPU Chart -->
                            <div class="p-4 border border-gray-100 rounded-xl bg-gray-50">
                                <h4 class="text-sm font-semibold text-gray-600 mb-4 flex items-center gap-2">
                                    <i class="ph-fill ph-cpu text-indigo-500"></i> CPU 사용량
                                </h4>
                                <div class="h-64">
                                    <canvas id="cpuChart"></canvas>
                                </div>
                            </div>

                            <!-- Memory Chart -->
                            <div class="p-4 border border-gray-100 rounded-xl bg-gray-50">
                                <h4 class="text-sm font-semibold text-gray-600 mb-4 flex items-center gap-2">
                                    <i class="ph-fill ph-memory text-green-500"></i> 메모리 사용량
                                </h4>
                                <div class="h-64">
                                    <canvas id="memoryChart"></canvas>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
                            <div class="p-4 bg-indigo-50 rounded-xl border border-indigo-100">
                                <div class="text-sm text-indigo-600 font-medium mb-1">플레이어</div>
                                <div class="text-2xl font-bold text-indigo-900" id="statPlayers">- / -</div>
                            </div>
                            <div class="p-4 bg-green-50 rounded-xl border border-green-100">
                                <div class="text-sm text-green-600 font-medium mb-1">상태</div>
                                <div class="text-2xl font-bold text-green-900" id="statHealth">Good</div>
                            </div>
                            <div class="p-4 bg-orange-50 rounded-xl border border-orange-100">
                                <div class="text-sm text-orange-600 font-medium mb-1">가동 시간</div>
                                <div class="text-2xl font-bold text-orange-900" id="statUptime">-</div>
                            </div>
                        </div>
                    </div>

                    <!-- Game Management Tab -->
                    <div id="tab-game" class="tab-content hidden space-y-6">

                        <!-- Global Actions -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Whitelist Toggle -->
                            <div class="p-4 border border-gray-100 rounded-xl bg-gray-50">
                                <h4 class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                                    <i class="ph-fill ph-shield-check text-indigo-500"></i> 화이트리스트 관리
                                </h4>
                                <div class="flex gap-2 mb-3">
                                    <button onclick="app.execCommand('whitelist on')"
                                        class="flex-1 bg-green-100 text-green-700 py-2 rounded hover:bg-green-200 transition-colors font-medium text-sm">ON</button>
                                    <button onclick="app.execCommand('whitelist off')"
                                        class="flex-1 bg-red-100 text-red-700 py-2 rounded hover:bg-red-200 transition-colors font-medium text-sm">OFF</button>
                                </div>
                                <div class="flex gap-2">
                                    <input type="text" id="whitelistAddInput" placeholder="유저명 추가..."
                                        class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded outline-none focus:ring-1 focus:ring-indigo-500">
                                    <button onclick="app.addToWhitelist()"
                                        class="bg-indigo-600 text-white px-3 py-2 rounded hover:bg-indigo-700 text-sm">추가</button>
                                </div>
                            </div>

                            <!-- Broadcast -->
                            <div class="p-4 border border-gray-100 rounded-xl bg-gray-50">
                                <h4 class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                                    <i class="ph-fill ph-megaphone text-orange-500"></i> 전체 공지
                                </h4>
                                <div class="flex gap-2">
                                    <input type="text" id="broadcastInput" placeholder="공지 메시지 입력..."
                                        class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded outline-none focus:ring-1 focus:ring-orange-500">
                                    <button onclick="app.broadcastMessage()"
                                        class="bg-orange-500 text-white px-3 py-2 rounded hover:bg-orange-600 text-sm">전송</button>
                                </div>
                            </div>
                        </div>

                        <!-- Player List -->
                        <div class="pt-4 border-t border-gray-100">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-bold text-gray-900">접속 중인 플레이어</h3>
                                <button onclick="app.fetchPlayers()"
                                    class="text-sm text-indigo-600 hover:text-indigo-800 flex items-center gap-1">
                                    <i class="ph-bold ph-arrows-clockwise"></i> 새로고침
                                </button>
                            </div>

                            <div class="overflow-x-auto border border-gray-200 rounded-lg">
                                <table class="w-full custom-table">
                                    <thead>
                                        <tr>
                                            <th>닉네임</th>
                                            <th>UUID</th>
                                            <th>체력</th>
                                            <th>게임모드</th>
                                            <th>관리</th>
                                        </tr>
                                    </thead>
                                    <tbody id="playerListBody">
                                        <tr>
                                            <td colspan="5" class="text-center py-8 text-gray-500">플레이어 목록을 불러오는 중...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Settings Tab -->
                    <div id="tab-settings" class="tab-content hidden space-y-8">
                        <div>
                            <h3 class="text-lg font-bold text-gray-900 mb-4">일반 설정</h3>
                            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 text-gray-500 text-sm">
                                현재 변경 가능한 설정이 없습니다.
                            </div>
                        </div>

                        <div class="pt-6 border-t border-gray-200">
                            <h3 class="text-lg font-bold text-red-600 mb-4">Danger Zone</h3>
                            <div
                                class="border border-red-200 rounded-lg p-6 bg-red-50 flex items-center justify-between">
                                <div>
                                    <h4 class="font-bold text-red-700">서버 삭제</h4>
                                    <p class="text-sm text-red-600 mt-1">이 작업은 되돌릴 수 없습니다. 모든 데이터가 영구적으로 삭제됩니다.</p>
                                </div>
                                <button onclick="app.confirmDeleteServer()"
                                    class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium transition-colors shadow-sm">
                                    서버 삭제
                                </button>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </template>

    <script>
        // CONFIG
        const CONFIG = {
            cognitoDomain: 'signup.aws-practice.shop',
            clientId: '7dl8gfi0lajbalghsdu476c259',
            redirectUri: 'https://aws-practice.shop/',
            scope: 'email openid phone',
            apiUrl: 'https://api.aws-practice.shop',
            region: 'ap-northeast-2'
        };

        // Application State & Logic
        const app = {
            state: {
                currentView: 'login',
                tokens: null,
                user: null,
                servers: [],
                selectedServer: null,
                charts: { cpu: null, memory: null },
                pollingInterval: null
            },

            init() {
                this.checkLogin();
                this.setupRouting();
            },

            setupRouting() {
                // Simple routing based on hash or just initial check
            },

            checkLogin() {
                // Check for auth code from redirect
                const urlParams = new URLSearchParams(window.location.search);
                const code = urlParams.get('code');
                const error = urlParams.get('error');

                if (error) {
                    alert(`Login Error: ${error}`);
                    window.history.replaceState({}, document.title, window.location.pathname);
                }

                if (code) {
                    exchangeCodeForTokens(code);
                    return;
                }

                // Check localStorage
                const savedTokens = localStorage.getItem('tokens');
                if (savedTokens) {
                    try {
                        const tokens = JSON.parse(savedTokens);
                        this.setSession(tokens);
                    } catch (e) {
                        console.error("Token parse error", e);
                        localStorage.removeItem('tokens');
                        this.render('login');
                    }
                } else {
                    this.render('login');
                }
            },

            setSession(tokens) {
                this.state.tokens = tokens;
                const payload = parseJwt(tokens.id_token);
                this.state.user = {
                    id: payload.sub,
                    username: payload['cognito:username'],
                    email: payload.email
                };

                // Update UI User Profile
                const userProfile = document.getElementById('userProfile');
                if (userProfile) {
                    userProfile.classList.remove('hidden');
                    userProfile.classList.add('flex');
                    document.getElementById('userName').textContent = this.state.user.username;
                    document.getElementById('userAvatar').textContent = this.state.user.username.charAt(0).toUpperCase();
                }

                this.navigateTo('dashboard');
            },

            navigateTo(view, data = null) {
                this.state.currentView = view;
                this.render(view, data);
            },

            render(view, data) {
                const root = document.getElementById('appRoot');
                const fab = document.getElementById('fab');

                // Cleanup
                if (this.state.pollingInterval) {
                    clearInterval(this.state.pollingInterval);
                    this.state.pollingInterval = null;
                }

                if (view === 'login') {
                    const userProfile = document.getElementById('userProfile');
                    if (userProfile) {
                        userProfile.classList.add('hidden');
                        userProfile.classList.remove('flex');
                    }
                    if (fab) fab.classList.add('hidden');

                    const tmpl = document.getElementById('tmpl-login');
                    root.innerHTML = tmpl.innerHTML;
                }
                else if (view === 'dashboard') {
                    if (fab) fab.classList.remove('hidden');
                    const tmpl = document.getElementById('tmpl-dashboard');
                    root.innerHTML = tmpl.innerHTML;
                    this.loadServers();
                }
                else if (view === 'control-panel') {
                    if (fab) fab.classList.add('hidden');

                    // data might be server object or server ID
                    if (typeof data === 'string') {
                        // Find by DataId
                        this.state.selectedServer = this.state.servers.find(s => s.DataId === data);
                    } else {
                        this.state.selectedServer = data;
                    }

                    if (!this.state.selectedServer) {
                        alert("서버 정보를 찾을 수 없습니다.");
                        this.navigateTo('dashboard');
                        return;
                    }

                    const tmpl = document.getElementById('tmpl-control-panel');
                    root.innerHTML = tmpl.innerHTML;
                    this.initControlPanel(this.state.selectedServer);
                }
            },

            // --- Dashboard Logic ---

            async loadServers() {
                const grid = document.getElementById('serverGrid');

                try {
                    const servers = await this.apiCall('/server', 'GET');
                    this.state.servers = Array.isArray(servers) ? servers : [];

                    let html = '';

                    if (this.state.servers.length === 0) {
                        // Display nothing if empty except create button which we append below
                    } else {
                        this.state.servers.forEach(server => {
                            html += this.buildServerCard(server);
                        });
                    }

                    // Append Create Card HTML (Centered Card)
                    html += `
                    <div onclick="app.openModal()" class="bg-white rounded-xl border-2 border-dashed border-gray-300 p-6 flex flex-col items-center justify-center text-gray-400 hover:border-indigo-500 hover:text-indigo-600 hover:bg-indigo-50 cursor-pointer transition-all min-h-[200px] group shadow-sm hover:shadow-md">
                        <div class="w-16 h-16 rounded-full bg-gray-100 group-hover:bg-white flex items-center justify-center mb-4 transition-colors">
                            <i class="ph-bold ph-plus text-3xl"></i>
                        </div>
                        <span class="font-medium">새 서버 만들기</span>
                    </div>
                    `;

                    grid.innerHTML = html;

                } catch (error) {
                    console.error("Load servers failed", error);
                    grid.innerHTML = `<div class="col-span-full text-red-500 bg-red-50 p-4 rounded-lg">서버 목록을 불러오는데 실패했습니다.<br>${error.message}</div>`;
                }
            },

            buildServerCard(server) {
                const statusColors = {
                    'running': 'bg-green-500',
                    'creating': 'bg-yellow-500',
                    'stopped': 'bg-red-500',
                    'stopping': 'bg-orange-500',
                    'starting': 'bg-blue-500'
                };
                const status = server.status.toLowerCase();
                const statusColor = statusColors[status] || 'bg-gray-400';

                const date = new Date(server.created_at * 1000).toLocaleDateString();
                const tierClass = `tier-badge-${server.tier}`;

                // Use ID for navigation instead of object string
                return `
                <div class="bg-white rounded-xl shadow-sm hover:shadow-lg transition-all p-6 border border-gray-100 relative group flex flex-col">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full ${statusColor} animate-pulse"></div>
                            <span class="text-xs font-semibold uppercase text-gray-500 tracking-wider">${server.status}</span>
                        </div>
                        <span class="text-xs font-bold px-2 py-1 rounded-md ${tierClass}">${server.tier}</span>
                    </div>
                    
                    <h3 class="text-xl font-bold text-gray-900 mb-1 truncate" title="${server.DataId}">${server.DataId}</h3>
                    <p class="text-sm text-gray-500 mb-6">Created: ${date}</p>
                    
                    <div class="mt-auto pt-4 border-t border-gray-50 flex gap-2">
                        <button onclick="app.navigateTo('control-panel', '${server.DataId}')" class="flex-1 bg-indigo-50 text-indigo-600 hover:bg-indigo-600 hover:text-white py-2 rounded-lg font-medium transition-colors text-sm">
                            관리하기
                        </button>
                    </div>
                </div>
                `;
            },

            // --- Create Modal Logic ---

            openModal() {
                document.getElementById('createModal').classList.remove('hidden');
                document.getElementById('inputPodName').value = '';
                document.getElementById('inputPvcName').value = '';
                // Clear checkboxes
                document.querySelectorAll('.form-checkbox').forEach(cb => cb.checked = false);
            },

            closeModal() {
                document.getElementById('createModal').classList.add('hidden');
            },

            handlePodNameInput(val) {
                // Filter invalid chars
                const cleanVal = val.toLowerCase().replace(/[^a-z0-9-]/g, '');
                if (val !== cleanVal) {
                    document.getElementById('inputPodName').value = cleanVal;
                }
                // Auto-generate PVC name
                if (cleanVal) {
                    document.getElementById('inputPvcName').value = cleanVal + '-pvc';
                } else {
                    document.getElementById('inputPvcName').value = '';
                }
            },

            generateRandomPassword() {
                const chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*";
                let pass = "";
                for (let i = 0; i < 16; i++) {
                    pass += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                return pass;
            },

            async submitCreateServer() {
                const podName = document.getElementById('inputPodName').value;
                const pvcName = document.getElementById('inputPvcName').value;
                // Generate secure random key in background since input is removed
                const key = this.generateRandomPassword();

                if (!podName) {
                    alert("서버 이름을 입력해주세요.");
                    return;
                }

                const btn = document.getElementById('btnCreateServer');
                const originalText = btn.innerHTML;
                btn.innerHTML = `<i class="ph-bold ph-spinner animate-spin"></i> 생성 중...`;
                btn.disabled = true;

                try {
                    await this.apiCall('/server', 'POST', {
                        pod_name: podName,
                        pvc_name: pvcName,
                        servertap_key: key
                    });

                    alert("서버 생성이 요청되었습니다. 목록이 갱신됩니다.");
                    this.closeModal();
                    this.loadServers();

                } catch (error) {
                    alert(`생성 실패: ${error.message}`);
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            },

            // --- Control Panel Logic ---

            initControlPanel(server) {
                document.getElementById('detailServerName').textContent = server.DataId;
                document.getElementById('detailServerIp').textContent = `${server.DataId}.aws-practice.shop`;

                // Render Power Controls based on Status
                this.renderPowerControls(server.status);
                this.updateStatusIndicator(server.status);

                // Init Charts
                this.initCharts();

                // Switch to default tab
                this.switchTab('overview');

                // Start polling if running
                if (server.status.toLowerCase() === 'running') {
                    this.fetchStatus();
                    this.state.pollingInterval = setInterval(() => this.fetchStatus(), 5000);
                }
            },

            updateStatusIndicator(status) {
                const statusColors = {
                    'running': 'bg-green-500',
                    'stopped': 'bg-red-500',
                    'creating': 'bg-yellow-500',
                    'stopping': 'bg-orange-500',
                    'starting': 'bg-blue-500'
                };
                const color = statusColors[status.toLowerCase()] || 'bg-gray-400';
                document.getElementById('detailStatusDot').className = `w-3 h-3 rounded-full ${color}`;
            },

            renderPowerControls(status) {
                const container = document.getElementById('powerControls');
                const s = status.toLowerCase();
                let html = '';

                if (s === 'running') {
                    html = `
                    <button onclick="app.controlServer('stop')" class="flex-1 bg-red-100 text-red-600 hover:bg-red-600 hover:text-white px-4 py-2 rounded-lg font-medium transition-colors text-sm flex items-center justify-center gap-2">
                        <i class="ph-fill ph-stop"></i> 정지
                    </button>
                    `;
                } else if (s === 'stopped') {
                    html = `
                    <button onclick="app.controlServer('start')" class="flex-1 bg-green-100 text-green-600 hover:bg-green-600 hover:text-white px-4 py-2 rounded-lg font-medium transition-colors text-sm flex items-center justify-center gap-2">
                        <i class="ph-fill ph-play"></i> 시작
                    </button>
                    `;
                } else {
                    html = `
                    <button disabled class="flex-1 bg-gray-100 text-gray-400 px-4 py-2 rounded-lg font-medium text-sm flex items-center justify-center gap-2 cursor-not-allowed">
                        <i class="ph-fill ph-spinner animate-spin"></i> 처리 중...
                    </button>
                    `;
                }
                container.innerHTML = html;
            },

            async controlServer(action) {
                if (!this.state.selectedServer) return;
                const podName = this.state.selectedServer.DataId;

                const btnContainer = document.getElementById('powerControls');
                btnContainer.innerHTML = `
                    <button disabled class="flex-1 bg-gray-100 text-gray-500 px-4 py-2 rounded-lg font-medium text-sm flex items-center justify-center gap-2 cursor-wait">
                        <i class="ph-bold ph-spinner animate-spin"></i> 요청 중...
                    </button>
                `;

                try {
                    await this.apiCall('/server', 'PATCH', {
                        pod_name: podName,
                        action: action
                    });

                    // Optimistic update
                    const newStatus = action === 'start' ? 'starting' : 'stopping';
                    this.state.selectedServer.status = newStatus;
                    this.updateStatusIndicator(newStatus);
                    this.renderPowerControls(newStatus);

                    alert(`서버 ${action === 'start' ? '시작' : '정지'} 요청을 보냈습니다.`);

                    setTimeout(() => {
                        this.navigateTo('dashboard'); // Go back to list to refresh
                    }, 2000);

                } catch (error) {
                    alert(`요청 실패: ${error.message}`);
                    this.renderPowerControls(this.state.selectedServer.status); // Revert
                }
            },

            switchTab(tabName) {
                // Update Buttons
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    if (btn.dataset.tab === tabName) {
                        btn.classList.add('bg-indigo-50', 'text-indigo-600', 'active-tab');
                        btn.classList.remove('text-gray-700', 'bg-white');
                    } else {
                        btn.classList.remove('bg-indigo-50', 'text-indigo-600', 'active-tab');
                        btn.classList.add('text-gray-700', 'bg-white');
                    }
                });

                // Update Content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.add('hidden');
                });
                document.getElementById(`tab-${tabName}`).classList.remove('hidden');

                // If switching to game tab, load players
                if (tabName === 'game') {
                    this.fetchPlayers();
                }
            },

            initCharts() {
                const cpuCtx = document.getElementById('cpuChart').getContext('2d');
                const memCtx = document.getElementById('memoryChart').getContext('2d');

                const commonOptions = {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 0 },
                    scales: {
                        x: { display: false },
                        y: { beginAtZero: true }
                    },
                    plugins: { legend: { display: false } }
                };

                // Destroy existing charts if any
                if (this.state.charts.cpu) this.state.charts.cpu.destroy();
                if (this.state.charts.memory) this.state.charts.memory.destroy();

                this.state.charts.cpu = new Chart(cpuCtx, {
                    type: 'line',
                    data: {
                        labels: Array(20).fill(''),
                        datasets: [{
                            label: 'CPU Usage',
                            data: Array(20).fill(0),
                            borderColor: '#6366f1',
                            tension: 0.4,
                            borderWidth: 2,
                            pointRadius: 0
                        }]
                    },
                    options: {
                        ...commonOptions,
                        scales: { ...commonOptions.scales, y: { suggestedMax: 100 } }
                    }
                });

                this.state.charts.memory = new Chart(memCtx, {
                    type: 'line',
                    data: {
                        labels: Array(20).fill(''),
                        datasets: [{
                            label: 'Memory (GB)',
                            data: Array(20).fill(0),
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true,
                            tension: 0.4,
                            borderWidth: 2,
                            pointRadius: 0
                        }]
                    },
                    options: {
                        ...commonOptions,
                        scales: { ...commonOptions.scales, y: { suggestedMax: 4 } } // Default max
                    }
                });
            },

            async fetchStatus(manual = false) {
                if (!this.state.selectedServer) return;

                try {
                    const data = await this.apiCall(`/server/status?pod_name=${this.state.selectedServer.DataId}`, 'GET');

                    if (data) {
                        this.updateDashboard(data);
                    }

                    if (manual) alert("상태가 갱신되었습니다.");

                } catch (error) {
                    console.warn("Status fetch failed", error);
                }
            },

            updateDashboard(data) {
                // Update text stats
                if (data.health) {
                    const freeMemGB = (data.health.freeMemory / 1024 / 1024 / 1024).toFixed(2);
                    const totalMemGB = (data.health.totalMemory / 1024 / 1024 / 1024).toFixed(2); // Max memory from health
                    const usedMemGB = (totalMemGB - freeMemGB).toFixed(2);

                    // Update Memory Chart
                    if (this.state.charts.memory) {
                        // Update max scale based on server total memory
                        this.state.charts.memory.options.scales.y.suggestedMax = parseFloat(totalMemGB);
                        this.updateChart(this.state.charts.memory, parseFloat(usedMemGB));
                    }

                    // Update CPU Chart
                    // Assuming we don't have direct CPU % in health, stick to fake/random for now or use core count logic if available later
                    if (this.state.charts.cpu) this.updateChart(this.state.charts.cpu, Math.random() * 20 + 5);

                    // Update Uptime
                    const uptimeHours = (data.health.uptime / 3600).toFixed(1);
                    document.getElementById('statUptime').textContent = `${uptimeHours}h`;
                }

                document.getElementById('statPlayers').textContent = `${data.onlinePlayers} / ${data.maxPlayers}`;

                const tps = parseFloat(data.tps);
                const healthEl = document.getElementById('statHealth');
                if (tps >= 18) {
                    healthEl.textContent = 'Good';
                    healthEl.className = 'text-2xl font-bold text-green-600';
                } else if (tps >= 12) {
                    healthEl.textContent = 'Fair';
                    healthEl.className = 'text-2xl font-bold text-yellow-600';
                } else {
                    healthEl.textContent = 'Poor';
                    healthEl.className = 'text-2xl font-bold text-red-600';
                }
            },

            updateChart(chart, newValue) {
                const data = chart.data.datasets[0].data;
                data.shift();
                data.push(newValue);
                chart.update();
            },

            // --- Game Management Logic ---

            async fetchPlayers() {
                if (!this.state.selectedServer) return;
                const tbody = document.getElementById('playerListBody');
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4">불러오는 중...</td></tr>';

                try {
                    const players = await this.apiCall(`/server/players?pod_name=${this.state.selectedServer.DataId}`, 'GET');

                    if (!players || players.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500">접속 중인 플레이어가 없습니다.</td></tr>';
                        return;
                    }

                    let html = '';
                    players.forEach(p => {
                        html += `
                        <tr>
                            <td class="font-medium flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full ${p.op ? 'bg-red-500' : 'bg-green-500'}"></span>
                                ${p.displayName}
                            </td>
                            <td class="font-mono text-xs text-gray-500">${p.uuid}</td>
                            <td>${Math.round(p.health)} / 20</td>
                            <td><span class="text-xs bg-gray-100 px-2 py-1 rounded">${p.gamemode}</span></td>
                            <td>
                                <div class="flex gap-1">
                                    <button onclick="app.kickPlayer('${p.displayName}')" class="bg-red-50 text-red-600 hover:bg-red-100 px-2 py-1 rounded text-xs">Kick</button>
                                    <button onclick="app.banPlayer('${p.displayName}')" class="bg-gray-800 text-white hover:bg-black px-2 py-1 rounded text-xs">Ban</button>
                                </div>
                            </td>
                        </tr>
                        `;
                    });
                    tbody.innerHTML = html;

                } catch (error) {
                    console.error("Fetch players error", error);
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-red-500 py-4">목록을 불러오지 못했습니다.</td></tr>';
                }
            },

            async execCommand(cmd) {
                if (!this.state.selectedServer) return;
                try {
                    await this.apiCall('/server/exec', 'POST', {
                        pod_name: this.state.selectedServer.DataId,
                        command: cmd
                    });
                    alert(`명령어 실행 성공: ${cmd}`);
                } catch (error) {
                    alert(`명령어 실패: ${error.message}`);
                }
            },

            async addToWhitelist() {
                const name = document.getElementById('whitelistAddInput').value.trim();
                if (!name) return;

                try {
                    await this.apiCall('/server/whitelist', 'POST', {
                        pod_name: this.state.selectedServer.DataId,
                        name: name
                    });
                    alert(`${name} 님을 화이트리스트에 추가했습니다.`);
                    document.getElementById('whitelistAddInput').value = '';
                } catch (error) {
                    alert(`추가 실패: ${error.message}`);
                }
            },

            async broadcastMessage() {
                const msg = document.getElementById('broadcastInput').value.trim();
                if (!msg) return;

                try {
                    await this.apiCall('/server/chat/broadcast', 'POST', {
                        pod_name: this.state.selectedServer.DataId,
                        message: msg
                    });
                    alert("공지 전송 완료");
                    document.getElementById('broadcastInput').value = '';
                } catch (error) {
                    alert(`전송 실패: ${error.message}`);
                }
            },

            async kickPlayer(name) {
                if (!confirm(`${name} 플레이어를 추방하시겠습니까?`)) return;
                try {
                    await this.apiCall('/server/player/kick', 'POST', {
                        pod_name: this.state.selectedServer.DataId,
                        name: name,
                        reason: "관리자에 의해 추방되었습니다."
                    });
                    alert(`${name} 추방 완료`);
                    this.fetchPlayers();
                } catch (error) {
                    alert(`추방 실패: ${error.message}`);
                }
            },

            async banPlayer(name) {
                if (!confirm(`${name} 플레이어를 영구 정지(Ban) 하시겠습니까?`)) return;
                try {
                    await this.apiCall('/server/ban', 'POST', { // Fixed endpoint based on provided text (exec/ban)
                        pod_name: this.state.selectedServer.DataId,
                        name: name
                    });
                    alert(`${name} 정지 완료`);
                    this.fetchPlayers();
                } catch (error) {
                    // Try alternate endpoint if first fails, user provided confusing paths
                    try {
                        await this.apiCall('/server/exec', 'POST', { // Fallback to exec ban command if dedicated endpoint fails
                            pod_name: this.state.selectedServer.DataId,
                            command: `ban ${name}`
                        });
                        alert(`${name} 정지 완료 (Command)`);
                        this.fetchPlayers();
                    } catch (e) {
                        alert(`정지 실패: ${error.message}`);
                    }
                }
            },

            async confirmDeleteServer() {
                const server = this.state.selectedServer;
                const confirmMsg = `정말로 ${server.DataId} 서버를 삭제하시겠습니까?\n이 작업은 되돌릴 수 없습니다.`;

                if (confirm(confirmMsg)) {
                    const podName = server.DataId;
                    const pvcName = server.pvc_name;

                    try {
                        const params = new URLSearchParams({
                            pod_name: podName,
                            pvc_name: pvcName
                        });

                        await this.apiCall(`/server?${params.toString()}`, 'DELETE');

                        alert("서버가 삭제되었습니다.");
                        this.navigateTo('dashboard');
                    } catch (error) {
                        alert(`삭제 실패: ${error.message}`);
                    }
                }
            },

            async apiCall(endpoint, method, body = null) {
                if (!this.state.tokens) throw new Error("No auth token");

                const headers = {
                    'Authorization': `Bearer ${this.state.tokens.id_token}`,
                    'Content-Type': 'application/json'
                };

                let url = endpoint.startsWith('http') ? endpoint : `${CONFIG.apiUrl}${endpoint}`;

                const options = {
                    method: method,
                    headers: headers
                };

                if (body) {
                    options.body = JSON.stringify(body);
                }

                const response = await fetch(url, options);

                if (response.status === 204) return null;

                const text = await response.text();
                let data;
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    data = text; // If empty or string
                    if (text === "") data = {}; // Handle empty OK response
                }

                if (!response.ok) {
                    throw new Error(data.message || JSON.stringify(data) || `API Error ${response.status}`);
                }

                return data;
            },

            copyToClipboard(text) {
                navigator.clipboard.writeText(text).then(() => {
                    alert("복사되었습니다: " + text);
                });
            }
        };

        // --- Global Functions for initial Auth ---

        function login() {
            const scopes = CONFIG.scope.split(' ').join('+');
            const authUrl = `https://${CONFIG.cognitoDomain}/login?` +
                `client_id=${CONFIG.clientId}&` +
                `response_type=code&` +
                `scope=${scopes}&` +
                `redirect_uri=${encodeURIComponent(CONFIG.redirectUri)}`;
            window.location.href = authUrl;
        }

        function logout() {
            localStorage.clear();
            const logoutUrl = `https://${CONFIG.cognitoDomain}/logout?` +
                `client_id=${CONFIG.clientId}&` +
                `logout_uri=${encodeURIComponent(CONFIG.redirectUri)}&` +
                `redirect_uri=${encodeURIComponent(CONFIG.redirectUri)}`;
            window.location.href = logoutUrl;
        }

        async function exchangeCodeForTokens(code) {
            try {
                const response = await fetch(`https://${CONFIG.cognitoDomain}/oauth2/token`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({
                        grant_type: 'authorization_code',
                        client_id: CONFIG.clientId,
                        code: code,
                        redirect_uri: CONFIG.redirectUri
                    })
                });

                if (!response.ok) throw new Error(`Token exchange failed: ${response.status}`);

                const tokens = await response.json();
                localStorage.setItem('tokens', JSON.stringify(tokens));
                window.history.replaceState({}, document.title, window.location.pathname);
                app.setSession(tokens);

            } catch (error) {
                alert(`Login Failed: ${error.message}`);
                app.render('login');
            }
        }

        function localLogin() {
            const idToken = document.getElementById('idTokenInput').value.trim();
            if (!idToken) return alert('Token required');

            try {
                parseJwt(idToken);
                const tokens = {
                    id_token: idToken,
                    access_token: 'dummy',
                    refresh_token: 'dummy'
                };
                localStorage.setItem('tokens', JSON.stringify(tokens));
                app.setSession(tokens);
            } catch (e) {
                alert('Invalid Token format');
            }
        }

        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function (c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch (e) {
                return {};
            }
        }

        window.onload = function () {
            app.init();
        };
    </script>
</body>

</html>