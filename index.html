<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cognito Login Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #333;
        }

        button {
            background-color: #FF9900;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }

        button:hover {
            background-color: #EC7211;
        }

        .token-display {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
            word-wrap: break-word;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .user-info {
            background-color: #e7f3ff;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }

        .error {
            background-color: #ffe7e7;
            color: #d32f2f;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }

        .success {
            background-color: #e7ffe7;
            color: #2f7d32;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }

        .loading {
            text-align: center;
            padding: 20px;
        }

        pre {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ” Cognito ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸</h1>

        <div id="loginSection">
            <p>Cognitoë¡œ ë¡œê·¸ì¸í•˜ì—¬ í† í°ì„ ë°œê¸‰ë°›ìœ¼ì„¸ìš”.</p>
            <button onclick="login()">Cognito ë¡œê·¸ì¸</button>

            <hr style="margin: 20px 0;">

            <h4>ë˜ëŠ”, ë¡œì»¬ í…ŒìŠ¤íŠ¸ìš© í† í° ë¶™ì—¬ë„£ê¸°</h4>
            <textarea id="idTokenInput" placeholder="ID Tokenì„ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”" style="width: 95%; min-height: 100px; margin-bottom: 10px; font-family: 'Courier New', monospace;"></textarea>
            <br>
            <button onclick="localLogin()" style="background-color: #555;">ë¡œì»¬ ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸</button>
        </div>

        <div id="loadingSection" style="display: none;">
            <div class="loading">
                <p>í† í°ì„ ë°›ì•„ì˜¤ëŠ” ì¤‘...</p>
            </div>
        </div>

        <div id="tokenSection" style="display: none;">
            <h2>âœ… ë¡œê·¸ì¸ ì„±ê³µ!</h2>

            <div class="user-info" id="userInfo"></div>

            <button onclick="testAPI()">API í…ŒìŠ¤íŠ¸ (Pods ì¡°íšŒ)</button>
            <button onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>

            <div id="apiResult"></div>
        </div>

        <div id="errorSection" style="display: none;">
            <div class="error" id="errorMessage"></div>
            <button onclick="location.reload()">ë‹¤ì‹œ ì‹œë„</button>
        </div>
    </div>

    <script>
        // âš ï¸ ì—¬ê¸°ì— ë³¸ì¸ì˜ Cognito ì •ë³´ ì…ë ¥í•˜ì„¸ìš”
        const CONFIG = {
            cognitoDomain: 'signup.aws-practice.shop',
            clientId: '7dl8gfi0lajbalghsdu476c259',
            redirectUri: 'https://aws-practice.shop/',
            scope: 'email openid phone',  // âœ… phone ì¶”ê°€, profile ì œê±°
            apiUrl: 'YOUR_API_GATEWAY_URL',
            region: 'ap-northeast-2'
        };

        // ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­
        function login() {
            const scopes = CONFIG.scope.split(' ').join('+');
            const authUrl = `https://${CONFIG.cognitoDomain}/login?` +
                `client_id=${CONFIG.clientId}&` +
                `response_type=code&` +
                `scope=${scopes}&` +
                `redirect_uri=${encodeURIComponent(CONFIG.redirectUri)}`;

            window.location.href = authUrl;
        }

        // ë¡œì»¬ í…ŒìŠ¤íŠ¸ìš© ë¡œê·¸ì¸
        function localLogin() {
            const idToken = document.getElementById('idTokenInput').value;

            if (!idToken || !idToken.trim()) {
                alert('ID Tokenì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            let payload;
            try {
                // í† í°ì´ ìœ íš¨í•œ JWT í˜•ì‹ì¸ì§€ í™•ì¸í•˜ê³  payload íŒŒì‹±
                payload = parseJwt(idToken);
                if (!payload.sub || !payload['cognito:username']) {
                    throw new Error('í•„ìˆ˜ í´ë ˆì„(sub, cognito:username)ì´ ì—†ìŠµë‹ˆë‹¤.');
                }
            } catch (e) {
                alert(`ìœ íš¨í•˜ì§€ ì•Šì€ í† í°ì…ë‹ˆë‹¤: ${e.message}`);
                return;
            }

            // Cognitoì—ì„œ ì˜¤ëŠ” ê²ƒê³¼ ìœ ì‚¬í•œ ê°ì²´ ìƒì„±
            const tokens = {
                id_token: idToken,
                access_token: 'local_test_access_token', // ì‹¤ì œ ì‚¬ìš©ë˜ì§€ ì•ŠëŠ” ë”ë¯¸ ê°’
                refresh_token: 'local_test_refresh_token',
                expires_in: 3600,
                token_type: 'Bearer'
            };

            // í† í° ì €ì¥ ë° í™”ë©´ í‘œì‹œ
            localStorage.setItem('tokens', JSON.stringify(tokens));
            
            // ë¡œê·¸ì¸ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
            document.getElementById('loginSection').style.display = 'none';

            displayTokens(tokens);
        }

        // ë¡œê·¸ì•„ì›ƒ
        function logout() {
            localStorage.clear();
            const logoutUrl = `https://${CONFIG.cognitoDomain}/logout?` +
                `client_id=${CONFIG.clientId}&` +
                `logout_uri=${encodeURIComponent(CONFIG.redirectUri)}&` +
                `redirect_uri=${encodeURIComponent(CONFIG.redirectUri)}`;  // âœ… ì¶”ê°€

            window.location.href = logoutUrl;
        }
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        window.onload = function () {
            // URLì—ì„œ authorization code í™•ì¸
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const error = urlParams.get('error');

            if (error) {
                showError(`ë¡œê·¸ì¸ ì‹¤íŒ¨: ${error}`);
                return;
            }

            // ì €ì¥ëœ í† í° í™•ì¸
            const savedTokens = localStorage.getItem('tokens');
            if (savedTokens) {
                displayTokens(JSON.parse(savedTokens));
                return;
            }

            // Authorization codeê°€ ìˆìœ¼ë©´ í† í°ìœ¼ë¡œ êµí™˜
            if (code) {
                exchangeCodeForTokens(code);
            }
        };

        // Authorization Codeë¥¼ í† í°ìœ¼ë¡œ êµí™˜
        async function exchangeCodeForTokens(code) {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('loadingSection').style.display = 'block';

            try {
                const response = await fetch(`https://${CONFIG.cognitoDomain}/oauth2/token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams({
                        grant_type: 'authorization_code',
                        client_id: CONFIG.clientId,
                        code: code,
                        redirect_uri: CONFIG.redirectUri
                    })
                });

                if (!response.ok) {
                    throw new Error(`í† í° êµí™˜ ì‹¤íŒ¨: ${response.status}`);
                }

                const tokens = await response.json();

                // í† í° ì €ì¥
                localStorage.setItem('tokens', JSON.stringify(tokens));

                // URLì—ì„œ code ì œê±°
                window.history.replaceState({}, document.title, window.location.pathname);

                displayTokens(tokens);

            } catch (error) {
                showError(`í† í° ë°œê¸‰ ì˜¤ë¥˜: ${error.message}`);
            }
        }

        // í† í° ì •ë³´ í‘œì‹œ
        function displayTokens(tokens) {
            document.getElementById('loadingSection').style.display = 'none';
            document.getElementById('tokenSection').style.display = 'block';

            // JWT ë””ì½”ë”© (ê°„ë‹¨í•œ íŒŒì‹±, ê²€ì¦ì€ ì•ˆ í•¨)
            const idTokenPayload = parseJwt(tokens.id_token);

            // ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
            document.getElementById('userInfo').innerHTML = `
                <strong>ì‚¬ìš©ì ID:</strong> ${idTokenPayload.sub}<br>
                <strong>ì´ë©”ì¼:</strong> ${idTokenPayload.email || 'N/A'}<br>
                <strong>ì‚¬ìš©ìëª…:</strong> ${idTokenPayload['cognito:username'] || 'N/A'}
            `;
        }

        // JWT íŒŒì‹± (Base64 ë””ì½”ë”©)
        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function (c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch (e) {
                return {};
            }
        }

        // API í…ŒìŠ¤íŠ¸
        async function testAPI() {
            const tokens = JSON.parse(localStorage.getItem('tokens'));
            const resultDiv = document.getElementById('apiResult');

            resultDiv.innerHTML = '<div class="loading">API í˜¸ì¶œ ì¤‘...</div>';

            try {
                const response = await fetch(`${CONFIG.apiUrl}/pods`, {
                    method: 'GET',
                    headers: {
                        'Authorization': tokens.id_token,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h3>API í˜¸ì¶œ ì„±ê³µ!</h3>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">
                            <h3>API í˜¸ì¶œ ì‹¤íŒ¨</h3>
                            <p>Status: ${response.status}</p>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                }

            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h3>API í˜¸ì¶œ ì˜¤ë¥˜</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        // ì—ëŸ¬ í‘œì‹œ
        function showError(message) {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('loadingSection').style.display = 'none';
            document.getElementById('errorSection').style.display = 'block';
            document.getElementById('errorMessage').textContent = message;
        }
    </script>
</body>

</html>